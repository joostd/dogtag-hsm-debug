#### PREREQS ####

# check LDAP
ldapsearch -LLL -w Secret.123 -D "cn=Directory Manager" -H ldap://localhost
systemctl enable dirsrv.target; systemctl start dirsrv.target

# SOFTHSM

pkcs11-tool --module /usr/lib/softhsm/libsofthsm2.so -t
# no errors
modutil -dbdir /etc/pki/pki-tomcat/alias -list softhsm
# lists softhsm slots
certutil -d /etc/pki/pki-tomcat/alias -h softhsm -K -h Dogtag -f password 
# no keys found
certutil -d /etc/pki/pki-tomcat/alias -h softhsm -L -h internal -f password -n sslserver
# internal sslserver cert is generated
modutil -dbdir /etc/pki/pki-tomcat/alias -rawlist 
# lists both modules

# https://www.dogtagpki.org/wiki/Java_PKCS11
# vi /lib/jvm/java-11-openjdk-amd64/conf/security/nss.cfg
# security.provider.7=sun.security.pkcs11.SunPKCS11 /etc/pki/nssdb/pkcs11.cfg
# grep softhsm /etc/pki/pki-tomcat/alias/pkcs11.txt

# maybe?
# security.provider.10=sun.security.pkcs11.SunPKCS11 ${java.home}/lib/security/nss.cfg
# https://github.com/dogtagpki/tomcatjss/issues/41

ls -l /usr/share/pki/etc/pki.conf /etc/pki/pki.conf 
https://github.com/dogtagpki/jss/issues/682#issuecomment-1299284671

##### SOLUTION FOR SOFTHSM #######


chmod 755 /var/lib/softhsm
chmod 1777 /var/lib/softhsm/tokens
chmod 777 /var/lib/softhsm -Rv

# keys are generated:
certutil -d /etc/pki/pki-tomcat/alias -h softhsm -K -h Dogtag -f password 
certutil: Checking token "Dogtag" in slot "SoftHSM slot ID 0x7f769a3c"
< 0> rsa      87ee65c7294f7abbff65821e8b54f3cabbdfdd2b   ca_signing
< 1> rsa      c7bae58f78e840729578aae6620b2a38749b7992   ca_audit_signing
< 2> rsa      eb4d448da76756deea32715f808da672776fcb9e   subsystem
< 3> rsa      e1cb41021b37c4b55d2032b29fad45e59474f9c2   ca_ocsp_signing

however:

# Feb 24 13:38:19 ubuntu-jammy pki-tomcat[14970]: SEVERE: Certificate not found: Dogtag:sslserver

Need to apply this patch:

https://github.com/dogtagpki/pki/commit/518a3e5c4415e7683baf9392bc8725b3fb587a9f


systemctl status pki-tomcatd@pki-tomcat.service
systemctl start pki-tomcatd@pki-tomcat.service
journalctl -xeu pki-tomcatd@pki-tomcat.service

##### YUBIHSM ######

ssh 127.0.0.1 -l vagrant -p 2222 -o "UserKnownHostsFile /dev/null" -i /Users/jodi/dogtag/ubuntu/.vagrant/machines/default/virtualbox/private_key -o "StrictHostKeyChecking no" -R 12345:localhost:12345

export YUBIHSM_PKCS11_CONF=/vagrant/yubihsm_pkcs11.conf
export YUBIHSM_PKCS11_MODULE=/usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so


pkcs11-tool --module $YUBIHSM_PKCS11_MODULE --pin 0001password -t
# no errors
modutil -dbdir /etc/pki/pki-tomcat/alias -list yubihsm
# lists yubihsm slots
certutil -d /etc/pki/pki-tomcat/alias -h yubihsm -K -h YubiHSM -f password 
# no keys found
certutil -d /etc/pki/pki-tomcat/alias -h yubihsm -L -h internal -f password -n sslserver
# internal sslserver cert is generated
modutil -dbdir /etc/pki/pki-tomcat/alias -rawlist 
# lists both modules





##########

sudo systemctl start pki-tomcatd@pki-tomcat.service

sudo systemctl start dirsrv.target

sudo certutil -d /etc/pki/pki-tomcat/alias -L

sudo pki -d /etc/pki/pki-tomcat/alias nss-cert-show sslserver


openssl pkcs12 -in /root/.dogtag/pki-tomcat/ca_admin_cert.p12

sudo certutil -d /root/.dogtag/pki-tomcat/ca/alias -L
sudo pki -d /root/.dogtag/pki-tomcat/ca/alias nss-cert-show caadmin

pk12util -i /root/.dogtag/pki-tomcat/ca_admin_cert.p12 -d /root/.dogtag/nssdb -W Secret.123

###### OR

# https://github.com/dogtagpki/pki/blob/DOGTAG_10_6_BRANCH/docs/installation/Installing_CA.md
python3 -c 'import socket; print(socket.getfqdn())'
pki -c Secret.123 client-init
pki -c Secret.123 client-cert-import  --pkcs12 ~/.dogtag/pki-tomcat/ca_admin_cert.p12  --pkcs12-password-file ~/.dogtag/pki-tomcat/ca/pkcs12_password.conf
certutil -L -d /root/.dogtag/nssdb/
pki -c Secret.123 -n caadmin ca-user-show caadmin

##### END

pki -U https://ubuntu-jammy:8443/ -d /root/.dogtag/nssdb -n caadmin ca-profile-find
pki -d /root/.dogtag/nssdb -n caadmin ca-profile-find

curl -k https://ubuntu-jammy:8443/ca/admin/ca/getStatus

pki -d /root/.dogtag/nssdb -n caadmin ca-cert-find
pki -d /root/.dogtag/nssdb -n caadmin ca-cert-find --name "CA Signing Certificate"
pki -d /root/.dogtag/nssdb -n caadmin ca-cert-find --name "ubuntu-jammy"

# show profile for Manual Certificate Manager Signing Certificate Enrollment

pki -d /root/.dogtag/nssdb -n caadmin ca-profile-show caCACert

####### ISSUING ######


openssl genrsa -out /tmp/key.pem 
openssl req -new -key /tmp/key.pem -subj '/CN=test' -out /tmp/csr.pem

pki -d /root/.dogtag/nssdb -n caadmin ca-cert-request-profile-show caCACert --output template.xml

apt install xsltproc jq
xsltproc --stringparam csr "$(cat /tmp/csr.pem)" template.xslt template.xml > request.xml


# pki -d /root/.dogtag/nssdb -n caadmin ca-cert-request-submit request.xml 
-----------------------------
Submitted certificate request
-----------------------------
  Request ID: 11
  Type: enrollment
  Request Status: pending
  Operation Result: success


# pki -d /root/.dogtag/nssdb -n caadmin ca-cert-request-approve 11
  Request ID: 11
  Profile: Manual Certificate Manager Signing Certificate Enrollment
  Type: enrollment
  Status: pending

  Certificate Request Input:
    cert_request_type: pkcs10
    cert_request: -----BEGIN CERTIFICATE REQUEST-----
MIICVDCCATwCAQAwDzENMAsGA1UEAwwEdGVzdDCCASIwDQYJKoZIhvcNAQEBBQAD
ggEPADCCAQoCggEBAL6fSzZIqDYaz+O4WamobixapcoALtNqz1sglijmTHd4CsAr
PpqKRyiar4+Q6DlfF1cMVLoenpVUCjuqu0oUet+D0ckoAbbzPpxA7UN2VQyP4wqG
4k2Hf0FJCmswiJvR2Dfvlx7wjNKBTpZrQSGl2MDXNzumnM8lACyhYiCkAwnBxg9m
GLBC0K2h0G/hovWnzGQbWXtviDK18DnQocINSS4NZK/oMB86nhGPavPwdYJ5wk6Y
hWUP0vUns5Z39hutASn8KNi0a06++bXsCqNiLwXf2/boseU9daqrxXXD/a3HV+Ii
XIs/ouLamp6LSf8gWZ6lyi7BnBUitFgnThjZG2MCAwEAAaAAMA0GCSqGSIb3DQEB
CwUAA4IBAQBumRmYdQ7heGzZ+w8fm5zzojNUY2gqVOeMpVPIL6VHdWPfTe/Fv22R
LSWFI/WwAM+eAE7JWywjEx3x/3ULmUAYqOJesv6lE0UXoYHwWgbkP+h8mPZJcu6f
MJatAX9OSoom7vfcBQI5YvJ9gyfTFxtYU6uB0I7iTtE/aeOgGrejVHiF/fO5jKA1
8SMMysbuWsFRTB2OMbr0qrriebcQPjW1pne32UqNf7x30K9WBZGi6h1vJFxZWCPA
DY7cqGtiLy/b5IsmbQX6nFnIDdC2hmani+yhVhdpgwINGcQ7p7LHrftdVeQ+0Itt
oeeQpjhubCvoWUlj/n5SsewPPphZX01g
-----END CERTIFICATE REQUEST-----

  Requestor Information:
    none

Are you sure (y/N)? y
-------------------------------
Approved certificate request 11
-------------------------------
  Request ID: 11
  Type: enrollment
  Request Status: complete
  Operation Result: success
  Certificate ID: 0x7

# pki -d /root/.dogtag/nssdb -n caadmin ca-cert-find --name test
---------------
1 entries found
---------------
  Serial Number: 0x7
  Subject DN: CN=test
  Issuer DN: CN=CA Signing Certificate,OU=pki-tomcat,O=EXAMPLE
  Status: VALID
  Type: X.509 version 3
  Key Algorithm: PKCS #1 RSA with 2048-bit key
  Not Valid Before: Fri Feb 24 09:03:12 UTC 2023
  Not Valid After: Tue Feb 24 07:48:16 UTC 2043
  Issued On: Fri Feb 24 09:08:09 UTC 2023
  Issued By: caadmin
----------------------------
Number of entries returned 1
----------------------------


pki -d /root/.dogtag/nssdb -n caadmin ca-cert-export 0x7 | openssl x509  -noout -text

